---
title: "Chla analysis"
author: "Dunia"
date: "7/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plot3D)
```
Data files
```{r}
Intertidal <- read.csv("../processed_data/Intertidal Chla.csv")[,-1]
Intertidal <- Intertidal[!is.na(Intertidal$chla),]
Subtidal <- read.csv("../processed_data/Subtidal Chla.csv")[,-1]
Subtidal <- Subtidal[!is.na(Subtidal$chla),]

Intertidal$Depth <- (Intertidal$Depth.From + Intertidal$Depth.To) / 2
Intertidal[Intertidal$Depth == c("7"), "Depth"] <- 6.5
Intertidal[Intertidal$Depth == c("9"), "Depth"] <- 8.5
Subtidal$Depth <- (Subtidal$Depth.From + Subtidal$Depth.To) / 2
# Month.names <- c("a", "b", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February" )
# PigYear$MonthNr <-  match(PigYear$Month, Month.names)
```
```{r}
Intertidal$Number <- NA
Intertidal[Intertidal$Year == c("2018") & Intertidal$MonthNr == c("3"), "Number" ] <- 1
Intertidal[Intertidal$Year == c("2018") & Intertidal$MonthNr == c("4"), "Number" ] <- 2
Intertidal[Intertidal$Year == c("2018") & Intertidal$MonthNr == c("7"), "Number" ] <- 3
Intertidal[Intertidal$Year == c("2018") & Intertidal$MonthNr == c("8"), "Number" ] <- 4
Intertidal[Intertidal$Year == c("2018") & Intertidal$MonthNr == c("9"), "Number" ] <- 5
Intertidal[Intertidal$Year == c("2018") & Intertidal$MonthNr == c("10"), "Number" ] <- 6
Intertidal[Intertidal$Year == c("2018") & Intertidal$MonthNr == c("11"), "Number" ] <- 7
Intertidal[Intertidal$Year == c("2018") & Intertidal$MonthNr == c("12"), "Number" ] <- 8
Intertidal[Intertidal$Year == c("2019") & Intertidal$MonthNr == c("1"), "Number" ] <- 9
Intertidal[Intertidal$Year == c("2019") & Intertidal$MonthNr == c("2"), "Number" ] <- 10
Intertidal[Intertidal$Year == c("2019") & Intertidal$MonthNr == c("3"), "Number" ] <- 11
Intertidal[Intertidal$Year == c("2019") & Intertidal$MonthNr == c("4"), "Number" ] <- 12
Intertidal[Intertidal$Year == c("2019") & Intertidal$MonthNr == c("5"), "Number" ] <- 13
Intertidal[Intertidal$Year == c("2019") & Intertidal$MonthNr == c("6"), "Number" ] <- 14

```

```{r}
Intermean <- data.frame(aggregate(list(Chla =Intertidal[,"chla"]), list(Site = Intertidal$Site, MonthNr = Intertidal$MonthNr, Year = Intertidal$Year, Date = Intertidal$Date, Depth = Intertidal$Depth, Number = Intertidal$Number), FUN = mean))

# Intermean <- Intermean[order(Intermean[,"MonthNr"], decreasing = F),]
# Intermean <- Intermean[order(Intermean[,"Depth"], decreasing = F),]
# Intermean <- Intermean[order(Intermean[,"Year"], decreasing = F),]
```
#Intertidal
Depth profiles per site per month
```{r,fig.width = 15, fig.height = 7}
par(mfrow = c(1,3), xpd = TRUE, mar = c(1,3,3,1), oma = c(1,4,4,1))

Yearlines <- function(Data = Intermean, Station, col){
  Site  <- Data[Data$Site == Station, ]
  Moname <- unique(Site$Number)
  
 plot(y = -Site$Depth, x = Site[,"Chla"], log = "x", type = "n", 
         main = " ", bty = "n", cex.axis = 1.5,  
         ylim = c(-10,0), xlab = " ", xaxt = "n", ylab = " ")
 if(Station == "Dortsman"){
 mtext("DT", cex = 2.5, line = 4)}
 else if (Station == "Olzenden"){
 mtext("OZ", cex = 2.5, line = 4)}
 else if (Station == "Zandkreek"){
 mtext("ZK", cex = 2.5, line = 4)}
 
  for (m in Moname) {
      Mon <- subset(Site, Number == m)                  # select corresponding Month
      with (Mon, lines(x = Mon[,"Chla"], y = -Depth, type = "l", lwd = 2, col = m)) 
      axis(side = 3, pos = 0, cex.axis = 1.5)
      mtext("ug/g", side = 3, line = 1.2, cex = 1.7)
}
 mtext("cm", side = 2, cex = 2, line = 1, outer = T )
 
 if (Station == "Zandkreek"){
legend("bottomright", text.col = Moname, legend = c("Mar 2018", "Apr 18", "Jul 18", "Aug 18", "Sep 18", "Oct 18", "Nov 18", "Dec 18", "Jan 19", "Feb 19","Mar 19", "Apr 19", "May 19", "Jun 19"), cex = 1.5, bty = "n") }
}
Stats <- unique(Intermean$Site)
Dat <- length(unique(Intermean$Number))

# gradient <- colorRampPalette(colors = c("green", "red", "blue")) 
# colours <- gradient(length(Dat))

for (i in 1:length(Stats))
 Yearlines(Station = Stats[i] ) # , col = colours)
```
The numbers from 1 to 14 correspond to the chronological order of the dates, starting in 2018 with the months: March, April, July, August, September, October, November, December and in 2019 January, February, March, May and June.
```{r}
Images <- function(Data = Intermean, Station, col = "black", log = FALSE, leg = FALSE){
  par(mar = c(4,4,3,0))
  Site <- subset(Data, Site == Station)
  Site2D <- reshape(Site[,c("Depth","Number", "Chla")], direction = "wide", 
       timevar = "Depth", idvar = "Number")
  Mon <- as.numeric(Site2D$Number)
  depth <- as.numeric(gsub(x=colnames(Site2D)[-1], "Chla.",""))
  colnames(Site2D)[-1] <- depth
  # this should be done properly: integrated over depth, taking into account thickness of slices and porosity
  plot(Mon, rowSums(Site2D[,-1], na.rm = T), type = "l", ylab = "?gChl/g", main = Station, xaxt = "n") 
  axis(1, at =c(1:14), labels= c("Mar 18", "Apr", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan 19", "Feb", "Mar", "Apr", "May", "Jun"))#Chla unit is per gram, we need to transform it to cm3
  par(mar = c(4,4,3,1))
   image2D(x = Mon, y = -depth, z = as.matrix(Site2D[,-1]), resfac = 4,
       xlab = "Month", ylab = "depth", xaxt = "n")
    axis(1, at =c(1:14), labels= c("Mar 18", "Apr", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan 19", "Feb", "Mar", "Apr", "May", "Jun"))
  par(mar = c(3,4,4,3))
  if (! log)
  matplot(x = t(Site2D[,-1]), y = depth, type = "l", col = "grey",
  lwd = 2, lty = 1)
  else
  matplot(x = t(Site2D[,-1]), y = depth, type = "l", col = jet.col(14),#"grey",
  lwd = 2, lty = 1, log = "y", ylim = c(10,0.2))
  
  if (leg) #Legend
  legend("bottomright", fill = jet.col(14), legend = Mon, title = "month", bty = "n")  
  
  invisible(Site2D)
  
}

par(mfcol = c(3,3), oma = c(2,0,0,2), las = 1)
LOG <- TRUE

DT <- Images(Station = "Dortsman", log = LOG)
OZ <- Images(Station = "Olzenden", log = LOG)
ZK <- Images(Station = "Zandkreek", log = LOG, leg = TRUE)

```
## Bioturbation estimates

The analytical solution of a model describes the concentration of a substance (Chl) versus depth (x) and that has only bioturbation (Db) and decay (k) is:    decay is also given as Lamda

Chl(x) = Chl(0)* exp(-sqrt(k/Db)*x)

The decay rate, k for chl is around 0.05/day, and usually it is assumed that there is no temperature dependence.
NOTE: Morys 2016 gives a K of 0.01/d for muddy sediments, 

Taking a log of both the right- and left-hand side, we get:

log(Chl(x)) = log(Chl(0)* exp(-sqrt(k/Db)*x))

log(Chl(x)) = -sqrt(k/Db)*x + log(Chl(0)) 

y = a*x + b

where coefficient "a" (the first coeff in a linear model) is -sqrt(k/db). Thus Db =1/(-a ^2/k) unit is Db= cm^2 / y

** NOTE for myself: The equation was transformed as follows: a = -sqrt(k/db) -> -a = sqrt(k/db) -> -a^2 = k/db -> db(-a^2) = k -> db = k/-a^2 then we multiply the right side numerator and denominator by 1/k so we get k (1/k) / -a^2 (1/k) and this results in 1 / (-a^2 / k)

This is assuming independence from temperature
```{r, fig.width=8, fig.height=8}
Depth <- (as.numeric(colnames(DT)[-1]))
#par(ask = TRUE)

LinMOd <- function(STa, prt = TRUE, k=0.05, maxD = rep(10, nrow(ST))){ #K = 0.01 in Morys and Karline suggests 0.05

DB <- rsq <- NULL
M <- STa[,1]
ST <- STa[,-1]
 par(mar = c(5, 4, 4, 4), oma = c(4,4,4,4))
for (i in 1:nrow(ST)){
  Dat <- ST[i,Depth <= maxD[i]]
  DD <- Depth[Depth <= maxD[i]]
  plot(Depth, log(ST[i,]), main = M[i], xlab = "Depth", ylab = "log(Chl)")
  dblm <- lm(log(as.numeric(Dat))~DD)
  sdblm<-summary(dblm)
  if(prt) print(sdblm)
  DB <- c(DB, k/(-coef(dblm)[1])^2)
  rsq <- c(rsq, sdblm$r.squared)
  abline(dblm)
}
 #mtext(outer = TRUE, side = 3,  ????formalArgs(LinMOd)[1] , cex = 1) #need to fix this so that it gives the name of the station

plot(M, DB, xlab = "Month", ylab = "Db cm2/d")
plot(M, rsq, xlab = "Month", ylab = "rsq")

  ZK_Db <- data.frame(month = M, db = DB, rsq = rsq)
  return(ZK_Db)
}

#par(mfrow = c(4, 3))
layout(matrix(c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,0,0), 4, 4, byrow = TRUE))
DTdb  <- LinMOd(DT, FALSE,  maxD = rep(4, times = 14)) 
OZdb <- LinMOd(OZ, FALSE, maxD = rep(4, times = 14))
ZKdb  <- LinMOd(ZK, FALSE,  maxD = rep(4, times = 14)) 

summary(DTdb)
summary(OZdb)
summary(ZKdb)
```
```{r}
par(mfrow = c(3,1))
plot(DTdb$month, DTdb$db, main = "Dortsman", xlab = "month", ylab = "Db, cm2/d", type = "b")
plot(OZdb$month, OZdb$db, main = "Olzenden", xlab = "month", ylab = "Db, cm2/d", type = "b")
plot(ZKdb$month, ZKdb$db, main = "Zandkreek", xlab = "month", ylab = "Db, cm2/d", type = "b")
```
```{r}
#Chl a total
TotInter <- data.frame(aggregate(list(Chla = Intertidal[,"chla"]), list(Site = Intertidal$Site, MonthNr = Intertidal$MonthNr, Number = Intertidal$Number), FUN = sum))
TotInter <- rbind(TotInter,list(Site = "Olzenden", MonthNr = "9", Number = "5", Chla = 0)) #There is no september measurements for Olzenden
#THIS IS REARRANGING THE PREVIOUS DATA FRAME SO THAT THE MONTH IS A COLUMN AND THE SITE A ROW
TInter <- rbind(t(subset(TotInter, Site == "Dortsman")[, "Chla"]), t(subset(TotInter, Site == "Olzenden")[, "Chla"]), t(subset(TotInter, Site == "Zandkreek")[, "Chla"]))
colnames(TInter) <- c(1:14)
rownames(TInter ) <- c("Dortsman", "Olzenden", "Zandkreek")
```

##Barplot of aggregated total concentration of Chla per site per month
```{r}
 # png("../graphs/Chla per month.png", height = 300, width = 500)
par(mar=c(2,2,1,1), oma=c(2,1,1,1))
barplot(TInter,beside = T, col = c("darkgray", "#009E73","#D55E00"), xlab = " ", ylab = " ")#log = "y", 
 mtext(outer = TRUE, side = 2, "ug/g", cex = 1)
 mtext(outer = TRUE, side = 1, "Month", cex = 1)
legend("topright", legend = rownames(TInter), text.col = c("darkgray", "#009E73","#D55E00"), bty = "n",  xpd = NA )
 # dev.off()
```
Is there a linear relationship between O2 fluxes and chla concentration?  slice 0 to 3
```{r}
#chla from 0 to 3 cm 
Chla3cm <- Intertidal[Intertidal$Depth < 3.25, ]
TotChla3cm <- data.frame(aggregate(list(Chla = Chla3cm[,"chla"]), list(Site = Chla3cm$Site, Month = Chla3cm$MonthNr, Number = Chla3cm$Number), FUN = sum))
TotChla3cm <- rbind(TotChla3cm,list(Site = "Olzenden", Month = "9", Number = 5, Chla = 0))
TotChla3cm <- TotChla3cm[order(TotChla3cm$Number),]
```
tranposing the TChla data
```{r}
TChla3cm <- rbind(t(subset(TotChla3cm, Site == "Dortsman")[, "Chla"]), t(subset(TotChla3cm, Site == "Olzenden")[, "Chla"]), t(subset(TotChla3cm, Site == "Zandkreek")[, "Chla"]))
colnames(TChla3cm) <- c("Mar 18", "Apr", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan 19", "Feb", "Mar", "Apr", "May", "Jun") #c(1:14)
rownames(TChla3cm ) <- c("Dortsman", "Olzenden", "Zandkreek")
```
#Barplot of total concentration of Chla per site per month first 3 cm
```{r}
par(mar=c(2,2,1,1), oma=c(2,1,1,1))
ChlaMonth3cm <- barplot(TChla3cm, beside = T, col = c("darkgray", "#009E73","#D55E00"), xlab = " ", ylab = " ")#, xaxt = "n")
 mtext(outer = TRUE, side = 2, "ug/g", cex = 1)
 mtext(outer = TRUE, side = 1, "Month", cex = 1)
legend("topright", legend = rownames(TChla3cm), text.col = c("darkgray", "#009E73","#D55E00"), bty = "n",  xpd = NA )
```

